/**
 * skylark-panolens - A version of panolens that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-panolens/
 * @license MIT
 */
define(["./TextureLoader"],function(t){"use strict";function s(t={}){let s;this._parameters=t,this._zoom=null,this._panoId=null,this._panoClient=new google.maps.StreetViewService,this._count=0,this._total=0,this._canvas=[],this._ctx=[],this._wc=0,this._hc=0,this.result=null,this.rotation=0,this.copyright="",this.onSizeChange=null,this.onPanoramaLoad=null,this.levelsW=[1,2,4,7,13,26],this.levelsH=[1,1,2,4,7,13],this.widths=[416,832,1664,3328,6656,13312],this.heights=[416,416,832,1664,3328,6656],this.maxW=6656,this.maxH=6656;try{const t=document.createElement("canvas");(s=t.getContext("experimental-webgl"))||(s=t.getContext("webgl"))}catch(t){}this.maxW=Math.max(s.getParameter(s.MAX_TEXTURE_SIZE),this.maxW),this.maxH=Math.max(s.getParameter(s.MAX_TEXTURE_SIZE),this.maxH)}return Object.assign(s.prototype,{constructor:s,setProgress:function(t,s){this.onProgress&&this.onProgress({loaded:t,total:s})},adaptTextureToZoom:function(){const t=this.widths[this._zoom],s=this.heights[this._zoom],o=this.maxW,i=this.maxH;this._wc=Math.ceil(t/o),this._hc=Math.ceil(s/i);for(let e=0;e<this._hc;e++)for(let h=0;h<this._wc;h++){const a=document.createElement("canvas");h<this._wc-1?a.width=o:a.width=t-o*h,e<this._hc-1?a.height=i:a.height=s-i*e,this._canvas.push(a),this._ctx.push(a.getContext("2d"))}},composeFromTile:function(t,s,o){const i=this.maxW,e=this.maxH;t*=512,s*=512;const h=Math.floor(t/i),a=Math.floor(s/e);t-=h*i,s-=a*e,this._ctx[a*this._wc+h].drawImage(o,0,0,o.width,o.height,t,s,512,512),this.progress()},progress:function(){this._count++,this.setProgress(this._count,this._total),this._count===this._total&&(this.canvas=this._canvas,this.panoId=this._panoId,this.zoom=this._zoom,this.onPanoramaLoad&&this.onPanoramaLoad(this._canvas[0]))},composePanorama:function(){this.setProgress(0,1);const s=this.levelsW[this._zoom],o=this.levelsH[this._zoom],i=this;this._count=0,this._total=s*o;const{useWebGL:e}=this._parameters;for(let h=0;h<o;h++)for(let o=0;o<s;o++){const s="https://geo0.ggpht.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&output=tile&zoom="+this._zoom+"&x="+o+"&y="+h+"&panoid="+this._panoId+"&nbt&fover=2";!function(o,h){if(e){const e=t.load(s,null,function(){i.composeFromTile(o,h,e)})}else{const t=new Image;t.addEventListener("load",function(){i.composeFromTile(o,h,this)}),t.crossOrigin="",t.src=s}}(o,h)}},load:function(t){this.loadPano(t)},loadPano:function(t){const s=this;this._panoClient.getPanoramaById(t,function(t,o){o===google.maps.StreetViewStatus.OK&&(s.result=t,s.copyright=t.copyright,s._panoId=t.location.pano,s.composePanorama())})},setZoom:function(t){this._zoom=t,this.adaptTextureToZoom()}}),s});
//# sourceMappingURL=../sourcemaps/loaders/GoogleStreetviewLoader.js.map
