/**
 * skylark-panolens - A version of panolens that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-panolens/
 * @license MIT
 */
define(["./panolens","./Constants","./lib/controls/OrbitControls","./lib/controls/DeviceOrientationControls","./lib/effects/CardboardEffect","./lib/effects/StereoEffect","./widget/Widget","./interface/Reticle","./infospot/Infospot","./DataImage","./panorama/Panorama","./panorama/VideoPanorama","./panorama/CameraPanorama","skylark-threejs","skylark-tweenjs"],function(t,e,i,n,s,o,a,r,c,h,d,l,u,p,m){"use strict";function v(t){let a;(t=t||{}).controlBar=void 0===t.controlBar||t.controlBar,t.controlButtons=t.controlButtons||["fullscreen","setting","video"],t.autoHideControlBar=void 0!==t.autoHideControlBar&&t.autoHideControlBar,t.autoHideInfospot=void 0===t.autoHideInfospot||t.autoHideInfospot,t.horizontalView=void 0!==t.horizontalView&&t.horizontalView,t.clickTolerance=t.clickTolerance||10,t.cameraFov=t.cameraFov||60,t.reverseDragging=t.reverseDragging||!1,t.enableReticle=t.enableReticle||!1,t.dwellTime=t.dwellTime||1500,t.autoReticleSelect=void 0===t.autoReticleSelect||t.autoReticleSelect,t.viewIndicator=void 0!==t.viewIndicator&&t.viewIndicator,t.indicatorSize=t.indicatorSize||30,t.output=t.output?t.output:"none",t.autoRotate=t.autoRotate||!1,t.autoRotateSpeed=t.autoRotateSpeed||2,t.autoRotateActivationDuration=t.autoRotateActivationDuration||5e3,this.options=t,t.container?((a=t.container)._width=a.clientWidth,a._height=a.clientHeight):((a=document.createElement("div")).classList.add("panolens-container"),a.style.width="100%",a.style.height="100%",a._width=window.innerWidth,a._height=window.innerHeight,document.body.appendChild(a)),this.container=a,this.camera=t.camera||new p.PerspectiveCamera(this.options.cameraFov,this.container.clientWidth/this.container.clientHeight,1,1e4),this.scene=t.scene||new p.Scene,this.renderer=t.renderer||new p.WebGLRenderer({alpha:!0,antialias:!1}),this.sceneReticle=new p.Scene,this.viewIndicatorSize=this.options.indicatorSize,this.reticle={},this.tempEnableReticle=this.options.enableReticle,this.mode=e.MODES.NORMAL,this.panorama=null,this.widget=null,this.hoverObject=null,this.infospot=null,this.pressEntityObject=null,this.pressObject=null,this.raycaster=new p.Raycaster,this.raycasterPoint=new p.Vector2,this.userMouse=new p.Vector2,this.updateCallbacks=[],this.requestAnimationId=null,this.cameraFrustum=new p.Frustum,this.cameraViewProjectionMatrix=new p.Matrix4,this.autoRotateRequestId=null,this.outputDivElement=null,this.touchSupported="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,this.HANDLER_MOUSE_DOWN=this.onMouseDown.bind(this),this.HANDLER_MOUSE_UP=this.onMouseUp.bind(this),this.HANDLER_MOUSE_MOVE=this.onMouseMove.bind(this),this.HANDLER_WINDOW_RESIZE=this.onWindowResize.bind(this),this.HANDLER_KEY_DOWN=this.onKeyDown.bind(this),this.HANDLER_KEY_UP=this.onKeyUp.bind(this),this.HANDLER_TAP=this.onTap.bind(this,{clientX:this.container.clientWidth/2,clientY:this.container.clientHeight/2}),this.OUTPUT_INFOSPOT=!1,this.tweenLeftAnimation=new m.Tween,this.tweenUpAnimation=new m.Tween,this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setClearColor(0,0),this.renderer.autoClear=!1,this.renderer.domElement.classList.add("panolens-canvas"),this.renderer.domElement.style.display="block",this.container.style.backgroundColor="#000",this.container.appendChild(this.renderer.domElement),this.orbitControls=new i(this.camera,this.container),this.orbitControls.id="orbit",this.orbitControls.minDistance=1,this.orbitControls.noPan=!0,this.orbitControls.autoRotate=this.options.autoRotate,this.orbitControls.autoRotateSpeed=this.options.autoRotateSpeed,this.deviceOrientationControls=new n(this.camera,this.container),this.deviceOrientationControls.id="device-orientation",this.deviceOrientationControls.enabled=!1,this.camera.position.z=1,this.options.passiveRendering&&console.warn("passiveRendering is now deprecated"),this.controls=[this.orbitControls,this.deviceOrientationControls],this.control=this.orbitControls,this.cardboardEffect=new s(this.renderer),this.cardboardEffect.setSize(this.container.clientWidth,this.container.clientHeight),this.stereoEffect=new o(this.renderer),this.stereoEffect.setSize(this.container.clientWidth,this.container.clientHeight),this.effect=this.cardboardEffect,this.addReticle(),this.options.horizontalView&&(this.orbitControls.minPolarAngle=Math.PI/2,this.orbitControls.maxPolarAngle=Math.PI/2),!1!==this.options.controlBar&&this.addDefaultControlBar(this.options.controlButtons),this.options.viewIndicator&&this.addViewIndicator(),this.options.reverseDragging&&this.reverseDraggingDirection(),this.options.enableReticle?this.enableReticleControl():this.registerMouseAndTouchEvents(),"overlay"===this.options.output&&this.addOutputElement(),this.registerEventListeners(),this.animate.call(this)}return v.prototype=Object.assign(Object.create(p.EventDispatcher.prototype),{constructor:v,add:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}this.scene.add(t),t.addEventListener&&t.addEventListener("panolens-viewer-handler",this.eventHandler.bind(this)),t instanceof d&&t.dispatchEvent&&t.dispatchEvent({type:"panolens-container",container:this.container}),t instanceof u&&t.dispatchEvent({type:"panolens-scene",scene:this.scene}),"panorama"===t.type&&(this.addPanoramaEventListener(t),this.panorama||this.setPanorama(t))},remove:function(t){t.removeEventListener&&t.removeEventListener("panolens-viewer-handler",this.eventHandler.bind(this)),this.scene.remove(t)},addDefaultControlBar:function(t){if(this.widget)return void console.warn("Default control bar exists");const e=new a(this.container);e.addEventListener("panolens-viewer-handler",this.eventHandler.bind(this)),e.addControlBar(),t.forEach(t=>{e.addControlButton(t)}),this.widget=e},setPanorama:function(t){const e=this.panorama;if("panorama"===t.type&&e!==t){this.hideInfospot();const i=function(){e&&e.onLeave(),t.removeEventListener("enter-fade-start",i)};t.addEventListener("enter-fade-start",i),(this.panorama=t).onEnter()}},eventHandler:function(t){t.method&&this[t.method]&&this[t.method](t.data)},dispatchEventToChildren:function(t){this.scene.traverse(function(e){e.dispatchEvent&&e.dispatchEvent(t)})},activateWidgetItem:function(t,i){const n=this.widget.mainMenu,s=n.children[0],o=n.children[1];let a;if(void 0!==t){switch(t){case 0:a=s.subMenu.children[1];break;case 1:a=s.subMenu.children[2];break;default:a=s.subMenu.children[1]}s.subMenu.setActiveItem(a),s.setSelectionTitle(a.textContent)}if(void 0!==i){switch(i){case e.MODES.CARDBOARD:a=o.subMenu.children[2];break;case e.MODES.STEREO:a=o.subMenu.children[3];break;default:a=o.subMenu.children[1]}o.subMenu.setActiveItem(a),o.setSelectionTitle(a.textContent)}},enableEffect:function(t){if(this.mode===t)return;if(t===e.MODES.NORMAL)return void this.disableEffect();this.mode=t;const i=this.camera.fov;switch(t){case e.MODES.CARDBOARD:case e.MODES.STEREO:this.effect=this.undefined,this.enableReticleControl();break;default:this.effect=null,this.disableReticleControl()}this.activateWidgetItem(void 0,this.mode),this.dispatchEventToChildren({type:"panolens-dual-eye-effect",mode:this.mode}),this.camera.fov=i+.01,this.effect.setSize(this.container.clientWidth,this.container.clientHeight),this.render(),this.camera.fov=i,this.dispatchEvent({type:"mode-change",mode:this.mode})},disableEffect:function(){this.mode!==e.MODES.NORMAL&&(this.mode=e.MODES.NORMAL,this.disableReticleControl(),this.activateWidgetItem(void 0,this.mode),this.dispatchEventToChildren({type:"panolens-dual-eye-effect",mode:this.mode}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.render(),this.dispatchEvent({type:"mode-change",mode:this.mode}))},enableReticleControl:function(){this.reticle.visible||(this.tempEnableReticle=!0,this.unregisterMouseAndTouchEvents(),this.reticle.show(),this.registerReticleEvent(),this.updateReticleEvent())},disableReticleControl:function(){this.tempEnableReticle=!1,this.options.enableReticle?this.updateReticleEvent():(this.reticle.hide(),this.unregisterReticleEvent(),this.registerMouseAndTouchEvents())},enableAutoRate:function(){this.options.autoRotate=!0,this.undefined.autoRotate=!0},disableAutoRate:function(){clearTimeout(this.autoRotateRequestId),this.options.autoRotate=!1,this.undefined.autoRotate=!1},toggleVideoPlay:function(t){this.panorama instanceof l&&this.panorama.dispatchEvent({type:"video-toggle",pause:t})},setVideoCurrentTime:function(t){this.panorama instanceof l&&this.panorama.dispatchEvent({type:"video-time",percentage:t})},onVideoUpdate:function(t){const{widget:e}=this;e&&e.dispatchEvent({type:"video-update",percentage:t})},addUpdateCallback:function(t){t&&this.updateCallbacks.push(t)},removeUpdateCallback:function(t){const e=this.updateCallbacks.indexOf(t);t&&e>=0&&this.updateCallbacks.splice(e,1)},showVideoWidget:function(){const{widget:t}=this;t&&t.dispatchEvent({type:"video-control-show"})},hideVideoWidget:function(){const{widget:t}=this;t&&t.dispatchEvent({type:"video-control-hide"})},updateVideoPlayButton:function(t){const{widget:e}=this;e&&e.videoElement&&e.videoElement.controlButton&&e.videoElement.controlButton.update(t)},addPanoramaEventListener:function(t){t.addEventListener("enter-fade-start",this.setCameraControl.bind(this)),t instanceof l&&(t.addEventListener("enter-fade-start",this.showVideoWidget.bind(this)),t.addEventListener("leave",function(){this.panorama instanceof l||this.hideVideoWidget.call(this)}.bind(this)))},setCameraControl:function(){this.undefined.target.copy(this.panorama.position)},getControl:function(){return this.control},getScene:function(){return this.scene},getCamera:function(){return this.camera},getRenderer:function(){return this.renderer},getContainer:function(){return this.container},getControlId:function(){return this.control.id},getNextControlId:function(){return this.controls[this.getNextControlIndex()].id},getNextControlIndex:function(){const t=this.controls,e=this.control,i=t.indexOf(e)+1;return i>=t.length?0:i},setCameraFov:function(t){this.camera.fov=t,this.camera.updateProjectionMatrix()},enableControl:function(t){switch(t=t>=0&&t<this.controls.length?t:0,this.control.enabled=!1,this.control=this.controls[t],this.control.enabled=!0,t){case e.CONTROLS.ORBIT:this.camera.position.copy(this.panorama.position),this.camera.position.z+=1;break;case e.CONTROLS.DEVICEORIENTATION:this.camera.position.copy(this.panorama.position)}this.control.update(),this.activateWidgetItem(t,void 0)},disableControl:function(){this.control.enabled=!1},toggleNextControl:function(){this.enableControl(this.getNextControlIndex())},getScreenVector:function(t){const e=t.clone(),i=this.container.clientWidth/2,n=this.container.clientHeight/2;return e.project(this.camera),e.x=e.x*i+i,e.y=-e.y*n+n,e.z=0,e},checkSpriteInViewport:function(t){return this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.cameraViewProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.cameraFrustum.setFromMatrix(this.cameraViewProjectionMatrix),t.visible&&this.cameraFrustum.intersectsSprite(t)},reverseDraggingDirection:function(){this.undefined.rotateSpeed*=-1,this.undefined.momentumScalingFactor*=-1},addReticle:function(){this.reticle=new r(16777215,!0,this.options.dwellTime),this.reticle.hide(),this.camera.add(this.reticle),this.sceneReticle.add(this.camera)},tweenControlCenter:function(t,e,i){if(this.control!==this.undefined)return;let n,s,o,a,r,c,h,d,l,u;t instanceof Array&&(e=t[1],i=t[2],t=t[0]),e=void 0!==e?e:1e3,i=i||m.Easing.Exponential.Out,n=this,r=(a=this.camera.getWorldDirection(new p.Vector3)).clone(),d=this.panorama.getWorldPosition(new p.Vector3).sub(this.camera.getWorldPosition(new p.Vector3)),(c=t.clone()).x*=-1,c.add(d).normalize(),h=c.clone(),a.y=0,c.y=0,s=(s=(s=Math.atan2(c.z,c.x)-Math.atan2(a.z,a.x))>Math.PI?s-2*Math.PI:s)<-Math.PI?s+2*Math.PI:s,o=Math.abs(r.angleTo(a)+(r.y*h.y<=0?h.angleTo(c):-h.angleTo(c))),o*=h.y<r.y?1:-1,l={left:0,up:0},u={left:0,up:0},this.tweenLeftAnimation.stop(),this.tweenUpAnimation.stop(),this.tweenLeftAnimation=new m.Tween(l).to({left:s},e).easing(i).onUpdate(function(t){n.control.rotateLeft(t.left-u.left),u.left=t.left}).start(),this.tweenUpAnimation=new m.Tween(l).to({up:o},e).easing(i).onUpdate(function(t){n.control.rotateUp(t.up-u.up),u.up=t.up}).start()},tweenControlCenterByObject:function(t,e,i){let n=!1;if(t.traverseAncestors(function(t){t.scalePlaceHolder&&(n=!0)}),n){const n=new p.Vector3(-1,1,1);this.tweenControlCenter(t.getWorldPosition(new p.Vector3).multiply(n),e,i)}else this.tweenControlCenter(t.getWorldPosition(new p.Vector3),e,i)},onWindowResize:function(t,e){let i,n;const s=this.container.classList.contains("panolens-container")||this.container.isFullscreen;if(void 0!==t&&void 0!==e)i=t,n=e,this.container._width=t,this.container._height=e;else{const t=/(android)/i.test(window.navigator.userAgent),e=t?Math.min(document.documentElement.clientWidth,window.innerWidth||0):Math.max(document.documentElement.clientWidth,window.innerWidth||0),o=t?Math.min(document.documentElement.clientHeight,window.innerHeight||0):Math.max(document.documentElement.clientHeight,window.innerHeight||0);i=s?e:this.container.clientWidth,n=s?o:this.container.clientHeight,this.container._width=i,this.container._height=n}this.camera.aspect=i/n,this.camera.updateProjectionMatrix(),this.renderer.setSize(i,n),(this.options.enableReticle||this.tempEnableReticle)&&this.updateReticleEvent(),this.dispatchEvent({type:"window-resize",width:i,height:n}),this.scene.traverse(function(t){t.dispatchEvent&&t.dispatchEvent({type:"window-resize",width:i,height:n})})},addOutputElement:function(){const t=document.createElement("div");t.style.position="absolute",t.style.right="10px",t.style.top="10px",t.style.color="#fff",this.container.appendChild(t),this.outputDivElement=t},outputPosition:function(){const t=this.raycaster.intersectObject(this.panorama,!0);if(t.length>0){const e=t[0].point.clone(),i=new p.Vector3(-1,1,1),n=this.panorama.getWorldPosition(new p.Vector3);e.sub(n).multiply(i);const s=`${e.x.toFixed(2)}, ${e.y.toFixed(2)}, ${e.z.toFixed(2)}`;if(0===e.length())return;switch(this.options.output){case"console":console.info(s);break;case"overlay":this.outputDivElement.textContent=s}}},onMouseDown:function(t){t.preventDefault(),this.userMouse.x=t.clientX>=0?t.clientX:t.touches[0].clientX,this.userMouse.y=t.clientY>=0?t.clientY:t.touches[0].clientY,this.userMouse.type="mousedown",this.onTap(t)},onMouseMove:function(t){t.preventDefault(),this.userMouse.type="mousemove",this.onTap(t)},onMouseUp:function(t){let e=!1;this.userMouse.type="mouseup";const i=this.userMouse.x>=t.clientX-this.options.clickTolerance&&this.userMouse.x<=t.clientX+this.options.clickTolerance&&this.userMouse.y>=t.clientY-this.options.clickTolerance&&this.userMouse.y<=t.clientY+this.options.clickTolerance||t.changedTouches&&this.userMouse.x>=t.changedTouches[0].clientX-this.options.clickTolerance&&this.userMouse.x<=t.changedTouches[0].clientX+this.options.clickTolerance&&this.userMouse.y>=t.changedTouches[0].clientY-this.options.clickTolerance&&this.userMouse.y<=t.changedTouches[0].clientY+this.options.clickTolerance?"click":void 0;if((!t||!t.target||t.target.classList.contains("panolens-canvas"))&&(t.preventDefault(),e=t.changedTouches&&1===t.changedTouches.length?this.onTap({clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY},i):this.onTap(t,i),this.userMouse.type="none",!e&&"click"===i)){const{options:{autoHideInfospot:t,autoHideControlBar:e},panorama:i,toggleControlBar:n}=this;t&&i&&i.toggleInfospotVisibility(),e&&n()}},onTap:function(t,e){const{left:i,top:n}=this.container.getBoundingClientRect(),{clientWidth:s,clientHeight:o}=this.container;if(this.raycasterPoint.x=(t.clientX-i)/s*2-1,this.raycasterPoint.y=-(t.clientY-n)/o*2+1,this.raycaster.setFromCamera(this.raycasterPoint,this.camera),!this.panorama)return;("mousedown"!==t.type&&this.touchSupported||this.OUTPUT_INFOSPOT)&&this.outputPosition();const a=this.raycaster.intersectObjects(this.panorama.children,!0),r=this.getConvertedIntersect(a),h=a.length>0?a[0].object:void 0;if("mouseup"===this.userMouse.type&&(r&&this.pressEntityObject===r&&this.pressEntityObject.dispatchEvent&&this.pressEntityObject.dispatchEvent({type:"pressstop-entity",mouseEvent:t}),this.pressEntityObject=void 0),"mouseup"===this.userMouse.type&&(h&&this.pressObject===h&&this.pressObject.dispatchEvent&&this.pressObject.dispatchEvent({type:"pressstop",mouseEvent:t}),this.pressObject=void 0),"click"===e?(this.panorama.dispatchEvent({type:"click",intersects:a,mouseEvent:t}),r&&r.dispatchEvent&&r.dispatchEvent({type:"click-entity",mouseEvent:t}),h&&h.dispatchEvent&&h.dispatchEvent({type:"click",mouseEvent:t})):(this.panorama.dispatchEvent({type:"hover",intersects:a,mouseEvent:t}),(this.hoverObject&&a.length>0&&this.hoverObject!==r||this.hoverObject&&0===a.length)&&(this.hoverObject.dispatchEvent&&(this.hoverObject.dispatchEvent({type:"hoverleave",mouseEvent:t}),this.reticle.end()),this.hoverObject=void 0),r&&a.length>0&&(this.hoverObject!==r&&(this.hoverObject=r,this.hoverObject.dispatchEvent&&(this.hoverObject.dispatchEvent({type:"hoverenter",mouseEvent:t}),(this.options.autoReticleSelect&&this.options.enableReticle||this.tempEnableReticle)&&this.reticle.start(this.onTap.bind(this,t,"click")))),"mousedown"===this.userMouse.type&&this.pressEntityObject!=r&&(this.pressEntityObject=r,this.pressEntityObject.dispatchEvent&&this.pressEntityObject.dispatchEvent({type:"pressstart-entity",mouseEvent:t})),"mousedown"===this.userMouse.type&&this.pressObject!=h&&(this.pressObject=h,this.pressObject.dispatchEvent&&this.pressObject.dispatchEvent({type:"pressstart",mouseEvent:t})),("mousemove"===this.userMouse.type||this.options.enableReticle)&&(h&&h.dispatchEvent&&h.dispatchEvent({type:"hover",mouseEvent:t}),this.pressEntityObject&&this.pressEntityObject.dispatchEvent&&this.pressEntityObject.dispatchEvent({type:"pressmove-entity",mouseEvent:t}),this.pressObject&&this.pressObject.dispatchEvent&&this.pressObject.dispatchEvent({type:"pressmove",mouseEvent:t}))),!r&&this.pressEntityObject&&this.pressEntityObject.dispatchEvent&&(this.pressEntityObject.dispatchEvent({type:"pressstop-entity",mouseEvent:t}),this.pressEntityObject=void 0),!h&&this.pressObject&&this.pressObject.dispatchEvent&&(this.pressObject.dispatchEvent({type:"pressstop",mouseEvent:t}),this.pressObject=void 0)),h&&h instanceof c){if(this.infospot=h,"click"===e)return!0}else this.infospot&&this.hideInfospot();this.options.autoRotate&&"mousemove"!==this.userMouse.type&&(clearTimeout(this.autoRotateRequestId),this.control===this.undefined&&(this.undefined.autoRotate=!1,this.autoRotateRequestId=window.setTimeout(this.enableAutoRate.bind(this),this.options.autoRotateActivationDuration)))},getConvertedIntersect:function(t){let e;for(let i=0;i<t.length;i++)if(t[i].distance>=0&&t[i].object&&!t[i].object.passThrough){if(t[i].object.entity&&t[i].object.entity.passThrough)continue;if(t[i].object.entity&&!t[i].object.entity.passThrough){e=t[i].object.entity;break}e=t[i].object;break}return e},hideInfospot:function(){this.infospot&&(this.infospot.onHoverEnd(),this.infospot=void 0)},toggleControlBar:function(){const{widget:t}=this;t&&t.dispatchEvent({type:"control-bar-toggle"})},onKeyDown:function(t){this.options.output&&"none"!==this.options.output&&"Control"===t.key&&(this.OUTPUT_INFOSPOT=!0)},onKeyUp:function(){this.OUTPUT_INFOSPOT=!1},update:function(){m.update(),this.updateCallbacks.forEach(function(t){t()}),this.control.update(),this.scene.traverse(function(t){if(t instanceof c&&t.element&&(this.hoverObject===t||"none"!==t.element.style.display||t.element.left&&"none"!==t.element.left.style.display||t.element.right&&"none"!==t.element.right.style.display))if(this.checkSpriteInViewport(t)){const{x:e,y:i}=this.getScreenVector(t.getWorldPosition(new p.Vector3));t.translateElement(e,i)}else t.onDismiss()}.bind(this))},render:function(){this.mode===e.MODES.CARDBOARD||this.mode===e.MODES.STEREO?(this.renderer.clear(),this.effect.render(this.scene,this.camera),this.effect.render(this.sceneReticle,this.camera)):(this.renderer.clear(),this.renderer.render(this.scene,this.camera),this.renderer.clearDepth(),this.renderer.render(this.sceneReticle,this.camera))},animate:function(){this.requestAnimationId=window.requestAnimationFrame(this.animate.bind(this)),this.onChange()},onChange:function(){this.update(),this.render()},registerMouseAndTouchEvents:function(){const t={passive:!1};this.container.addEventListener("mousedown",this.HANDLER_MOUSE_DOWN,t),this.container.addEventListener("mousemove",this.HANDLER_MOUSE_MOVE,t),this.container.addEventListener("mouseup",this.HANDLER_MOUSE_UP,t),this.container.addEventListener("touchstart",this.HANDLER_MOUSE_DOWN,t),this.container.addEventListener("touchend",this.HANDLER_MOUSE_UP,t)},unregisterMouseAndTouchEvents:function(){this.container.removeEventListener("mousedown",this.HANDLER_MOUSE_DOWN,!1),this.container.removeEventListener("mousemove",this.HANDLER_MOUSE_MOVE,!1),this.container.removeEventListener("mouseup",this.HANDLER_MOUSE_UP,!1),this.container.removeEventListener("touchstart",this.HANDLER_MOUSE_DOWN,!1),this.container.removeEventListener("touchend",this.HANDLER_MOUSE_UP,!1)},registerReticleEvent:function(){this.addUpdateCallback(this.HANDLER_TAP)},unregisterReticleEvent:function(){this.removeUpdateCallback(this.HANDLER_TAP)},updateReticleEvent:function(){const t=this.container.clientWidth/2+this.container.offsetLeft,e=this.container.clientHeight/2;this.removeUpdateCallback(this.HANDLER_TAP),this.HANDLER_TAP=this.onTap.bind(this,{clientX:t,clientY:e}),this.addUpdateCallback(this.HANDLER_TAP)},registerEventListeners:function(){window.addEventListener("resize",this.HANDLER_WINDOW_RESIZE,!0),window.addEventListener("keydown",this.HANDLER_KEY_DOWN,!0),window.addEventListener("keyup",this.HANDLER_KEY_UP,!0)},unregisterEventListeners:function(){window.removeEventListener("resize",this.HANDLER_WINDOW_RESIZE,!0),window.removeEventListener("keydown",this.HANDLER_KEY_DOWN,!0),window.removeEventListener("keyup",this.HANDLER_KEY_UP,!0)},dispose:function(){this.tweenLeftAnimation.stop(),this.tweenUpAnimation.stop(),this.unregisterEventListeners(),function t(e){for(let i=e.children.length-1;i>=0;i--)t(e.children[i]),e.remove(e.children[i]);e instanceof d||e instanceof c?(e.dispose(),e=null):e.dispatchEvent&&e.dispatchEvent("dispose")}(this.scene),this.widget&&(this.widget.dispose(),this.widget=null),p.Cache&&p.Cache.enabled&&p.Cache.clear()},destroy:function(){this.dispose(),this.render(),window.cancelAnimationFrame(this.requestAnimationId)},onPanoramaDispose:function(t){t instanceof l&&this.hideVideoWidget(),t===this.panorama&&(this.panorama=null)},loadAsyncRequest:function(t,e=(()=>{})){const i=new window.XMLHttpRequest;i.onloadend=function(t){e(t)},i.open("GET",t,!0),i.send(null)},addViewIndicator:function(){const t=this;this.loadAsyncRequest(h.ViewIndicator,function(e){if(0===e.loaded)return;const i=e.target.responseXML.documentElement;i.style.width=t.viewIndicatorSize+"px",i.style.height=t.viewIndicatorSize+"px",i.style.position="absolute",i.style.top="10px",i.style.left="10px",i.style.opacity="0.5",i.style.cursor="pointer",i.id="panolens-view-indicator-container",t.container.appendChild(i);const n=i.querySelector("#indicator");t.addUpdateCallback(function(){t.radius=.225*t.viewIndicatorSize,t.currentPanoAngle=t.camera.rotation.y-p.Math.degToRad(90),t.fovAngle=p.Math.degToRad(t.camera.fov),t.leftAngle=-t.currentPanoAngle-t.fovAngle/2,t.rightAngle=-t.currentPanoAngle+t.fovAngle/2,t.leftX=t.radius*Math.cos(t.leftAngle),t.leftY=t.radius*Math.sin(t.leftAngle),t.rightX=t.radius*Math.cos(t.rightAngle),t.rightY=t.radius*Math.sin(t.rightAngle),t.indicatorD="M "+t.leftX+" "+t.leftY+" A "+t.radius+" "+t.radius+" 0 0 1 "+t.rightX+" "+t.rightY,t.leftX&&t.leftY&&t.rightX&&t.rightY&&t.radius&&n.setAttribute("d",t.indicatorD)}),i.addEventListener("mouseenter",function(){this.style.opacity="1"}),i.addEventListener("mouseleave",function(){this.style.opacity="0.5"})})},appendControlItem:function(t){const e=this.widget.createCustomItem(t);return"video"===t.group?this.widget.videoElement.appendChild(e):this.widget.barElement.appendChild(e),e},clearAllCache:function(){p.Cache.clear()}}),t.Viewer=v});
//# sourceMappingURL=sourcemaps/Viewer.js.map
